<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Map-Reduce Organizer</title>
    <link rel="stylesheet" href="static/css/styles.css">
</head>
<body>
    <h1>Local Map-Reduce Organizer</h1>
    <button id="runBtn" onclick="runPipeline()">Run Analysis & Reduce</button>
    <div id="status">Ready.</div>
    <div id="results"></div>

    <script>
        let progressInterval = null;

        function updateProgress() {
            fetch('/progress')
                .then(res => res.json())
                .then(data => {
                    const status = document.getElementById('status');
                    if (data.running && data.total > 0) {
                        status.textContent = `Processing files: ${data.completed}/${data.total}`;
                    }
                });
        }

        function runPipeline() {
            const btn = document.getElementById('runBtn');
            const status = document.getElementById('status');
            btn.disabled = true;
            status.textContent = "Running Pipeline... (Scanning -> Gemini -> Map -> Reduce)";

            // Start polling for progress every 500ms
            progressInterval = setInterval(updateProgress, 500);

            fetch('/run')
                .then(res => res.json())
                .then(data => {
                    // Stop polling
                    clearInterval(progressInterval);
                    status.textContent = `Complete! Newly analyzed: ${data.newly_analyzed} files in ${data.elapsed_time_seconds}s.`;
                    loadView();
                    btn.disabled = false;
                })
                .catch(err => {
                    // Stop polling on error
                    clearInterval(progressInterval);
                    status.textContent = "Error: " + err;
                    btn.disabled = false;
                });
        }

        function loadView() {
            fetch('/data')
                .then(res => res.json())
                .then(data => render(data));
        }

        function render(data) {
            const container = document.getElementById('results');
            container.innerHTML = '';

            // data is { "finance": [ {name: "doc1", all_keys: ["finance", "urgent"]}, ... ] }
            for (const [genreKey, files] of Object.entries(data)) {
                let html = `
                    <div class="genre-group">
                        <div class="genre-header">${genreKey}</div>
                        <div class="file-list">
                `;

                files.forEach(file => {
                    // Render all tags, highlighting the one that matches the current header
                    const tagsHtml = file.all_keys.map(key => 
                        `<span class="key-pill ${key === genreKey ? 'active' : ''}">${key}</span>`
                    ).join('');

                    html += `
                        <div class="file-item">
                            <div class="file-name">${file.name}</div>
                            <div class="file-keys">${tagsHtml}</div>
                        </div>
                    `;
                });

                html += `</div></div>`;
                container.innerHTML += html;
            }
        }

        // Load existing data on page load
        loadView();
    </script>
</body>
</html>